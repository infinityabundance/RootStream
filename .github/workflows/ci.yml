name: RootStream CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        build-type: [release, debug]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            libdrm-dev \
            libva-dev \
            libsodium-dev \
            libopus-dev \
            libasound2-dev \
            libsdl2-dev \
            libgtk-3-dev \
            libavahi-client-dev \
            libqrencode-dev \
            libpng-dev

      - name: Build (${{ matrix.build-type }})
        run: |
          if [ "${{ matrix.build-type }}" = "debug" ]; then
            make DEBUG=1
          else
            make
          fi

      - name: Verify binary
        run: |
          ./rootstream --help || true
          file ./rootstream
          ldd ./rootstream || true

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: rootstream-${{ matrix.build-type }}
          path: rootstream

  unit-tests:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            libdrm-dev \
            libva-dev \
            libsodium-dev \
            libopus-dev \
            libasound2-dev \
            libsdl2-dev \
            libgtk-3-dev \
            libavahi-client-dev \
            libqrencode-dev \
            libpng-dev

      - name: Build tests
        run: make test-build

      - name: Run crypto tests
        run: ./tests/unit/test_crypto

      - name: Run encoding tests
        run: ./tests/unit/test_encoding

  integration-tests:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            libdrm-dev \
            libva-dev \
            libsodium-dev \
            libopus-dev \
            libasound2-dev \
            libsdl2-dev \
            libgtk-3-dev \
            libavahi-client-dev \
            libqrencode-dev \
            libpng-dev \
            xvfb

      - name: Build
        run: make

      - name: Run integration tests
        run: |
          # Some tests need a display
          xvfb-run --auto-servernum ./tests/integration/test_stream.sh || \
            ./tests/integration/test_stream.sh

  code-quality:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cppcheck \
            clang-tools

      - name: Run cppcheck
        run: |
          cppcheck --enable=warning,style,performance \
                   --suppress=missingIncludeSystem \
                   --error-exitcode=0 \
                   src/ include/

      - name: Check for common issues
        run: |
          # Check for TODO/FIXME counts (informational)
          echo "=== TODOs and FIXMEs ==="
          grep -rn "TODO\|FIXME" src/ include/ || echo "None found"

          # Check for potential security issues
          echo ""
          echo "=== Potential security patterns ==="
          grep -rn "strcpy\|sprintf\|gets" src/ || echo "None found (good!)"

  memory-check:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            libdrm-dev \
            libva-dev \
            libsodium-dev \
            libopus-dev \
            libasound2-dev \
            libsdl2-dev \
            libgtk-3-dev \
            libavahi-client-dev \
            libqrencode-dev \
            libpng-dev \
            valgrind

      - name: Build with debug symbols
        run: make DEBUG=1 test-build

      - name: Run valgrind on unit tests
        run: |
          valgrind --leak-check=full \
                   --show-leak-kinds=definite \
                   --error-exitcode=0 \
                   ./tests/unit/test_crypto 2>&1 | tee valgrind-crypto.log

          valgrind --leak-check=full \
                   --show-leak-kinds=definite \
                   --error-exitcode=0 \
                   ./tests/unit/test_encoding 2>&1 | tee valgrind-encoding.log

      - name: Upload valgrind logs
        uses: actions/upload-artifact@v4
        with:
          name: valgrind-logs
          path: valgrind-*.log
